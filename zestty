#!/bin/sh

# use strict error handling
set -eu


# if we are not in a zellij session, explicitly set the ZELLIJ environment
# variable to 1 so that we can use it in conditionals later
ZELLIJ=${ZELLIJ:-1}

bold()    { printf "\033[1m%s\033[0m" "$*"; }
success() { printf "\033[32m%s\033[0m\n" "$*"; }
info()    { printf "\033[36m%s\033[0m\n" "$*"; }
warn()    { printf "\033[33m%s\033[0m\n" "$*" 1>&2; }
error()   { printf "\033[31m%s\033[0m\n" "$*" 1>&2; }

exit_success() {
    exit_success_message=${1:-}
    [ -n "$exit_success_message" ] && success "$1"
    exit 0
}

exit_fail() {
    exit_fail_message=${1:-}
    [ -n "$exit_fail_message" ] && error "$1"
    exit 1
}

exit_fail_with_usage() {
    with_usage_message=${1:-}
    with_usage_function=${2:-}

    if [ -n "$with_usage_message" ]; then
        error "$with_usage_message"
    fi

    if [ -n "$with_usage_function" ]; then
        echo
        eval "$with_usage_function"
    fi

    exit 1
}

print_zestty_usage() {
    echo "$(cat <<EOF
usage: zestty <command>

$(bold "Available commands")
help        print this message
create      create a session with a name, layout, and working directory
EOF
    )"
}

print_create_usage() {
    echo "$(cat <<EOF
usage: zestty create <name> [path] [layout]

$(bold "Parameters")
name        name of the session
path        working directory for the session, defaults to current directory
layout      name of the layout to use, default layout if not provided
EOF
    )"
}

get_session_state() {
    name="$1"
    state="dne"
    session=$(
        zellij list-sessions --no-formatting 2> /dev/null | \
        grep "$name \["
    )

    if echo "$session" | grep --quiet "EXITED"; then
        state="dead"
    elif [ -n "$session" ]; then
        state="active"
    fi

    echo "$state"
}

call_zellij_switch_plugin() {
    if [ "$#" -lt "1" ]; then
        exit_fail "Session name required!"
    fi

    call_plugin_name="$1"
    call_plugin_path=${2:-}
    call_plugin_layout=${3:-}

    call_plugin_options="--session $call_plugin_name"
    if [ -n "$call_plugin_path" ] && [ -d "$call_plugin_path" ]; then
        call_plugin_options="$call_plugin_options --cwd $call_plugin_path"
    fi

    if [ -n "$call_plugin_layout" ]; then
        call_plugin_options="$call_plugin_options --layout $call_plugin_layout"
    fi

    zellij pipe --plugin zellij-switch -- "$call_plugin_options"
}

create_command() {
    if [ "$#" -lt "1" ]; then
        exit_fail_with_usage "Session name required!" print_create_usage
    fi

    create_command_cwd=$(pwd)
    create_command_name="$1"
    create_command_path=${2:-"$create_command_cwd"}
    create_command_layout=${3:-}

    if ! [ "$(get_session_state "$create_command_name")" = "dne" ]; then
        exit_fail_with_usage "Session already exists, use attach instead!" # print_attach_usage
    fi

    if ! [ -d "$create_command_path" ]; then
        exit_fail "'$create_command_path' is not a directory!"
    else
        create_command_path=$(realpath "$create_command_path")
    fi

    if [ "$ZELLIJ" = "0" ]; then
        call_zellij_switch_plugin \
            "$create_command_name" \
            "$create_command_path" \
            "$create_command_layout"
    else
        # pushd and popd are bash builtins and are not POSIX compliant
        cd "$create_command_path"

        if [ -n "$layout" ]; then
            zellij --session "$name" --new-session-with-layout "$layout"
        else
            zellij --session "$name"
        fi

        cd "$create_command_cwd"
    fi
}

# do not proceed if config is invalid
if ! zellij setup --check 1> /dev/null; then
    exit_fail
fi

if [ "$#" -lt "1" ]; then
    exit_fail_with_usage "" print_zestty_usage
fi

command="$1"
shift

case "$command" in
    "-?" | "-h" | "--help" | "help")
        print_zestty_usage
        ;;
    "create")
        create_command $@
        ;;
esac

exit_success
